id: net.v38armageddon.WebSM.Lite
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk

command: WebSM.Lite

finish-args:
  - --device=all
  # TODO: Replace this with wayland and fallback-x11 once Wayland support
  #       becomes available.
  - --socket=x11
  - --share=ipc
  - --share=network
  - --filesystem=xdg-pictures
  - --filesystem=xdg-music
  - --filesystem=xdg-videos
  - --filesystem=/run/media
  - --filesystem=/media
  - --talk-name=org.freedesktop.portal.Audio
  - --talk-name=org.freedesktop.portal.Camera
  - --talk-name=org.freedesktop.portal.Flatpak
  - --filesystem=/usr/lib:ro
  - --filesystem=/lib:ro
  - --env=LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/lib/x86_64-linux-gnu
  - --env=WEBKIT_DISABLE_SANDBOX_THIS_IS_DANGEROUS=1

modules:
  - name: data
    buildsystem: simple
    sources:
      - type: file
        path: net.v38armageddon.WebSM.Lite.desktop
      - type: file
        path: publish/Assets/Icons/icon_foreground.png
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/share/applications
      - cp net.v38armageddon.WebSM.Lite.desktop ${FLATPAK_DEST}/share/applications/
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps
      - cp icon_foreground.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/net.v38armageddon.WebSM.Lite.png

  - name: WebSM.Lite
    buildsystem: simple
    sources:
      - type: dir
        path: publish
    build-commands:
      - mkdir -p /app/bin
      - cp -r ./* /app/bin
      - chmod +x /app/bin/WebSM.Lite
      # HACK: Link libs to the binaries so Uno detects WebKit
      - ln -s /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so.0 /app/bin/libwebkit2gtk-4.1.so
      - ln -s /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so.0 /app/bin/libwebkit2gtk-4.0.so
      - ln -s /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so.0 /app/bin/libwebkit2gtk-4.0.so.37
      - ln -s /usr/lib/x86_64-linux-gnu/libgdk-3.so.0 /app/bin/libgdk-3.so
      - ln -s /usr/lib/x86_64-linux-gnu/libgtk-3.so.0 /app/bin/libgtk-3.so
      - ln -s /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.1.so.0 /app/bin/libjavascriptcoregtk-4.1.so

      - ln -s /app/bin/WebSM.Lite /app/WebSM.Lite
